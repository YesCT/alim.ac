<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      alim.ac
      XHProf and Drupal, in two flavors
    </title>

    <link href="../../css/normalize-ec2a8901.css" rel="stylesheet" type="text/css" />
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet" type="text/css" />
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../../css/main-556e3750.css" rel="stylesheet" type="text/css" />

    <script src="../../js/vendor/modernizr-2.6.1.min-68fdcc99.js" type="text/javascript"></script>
  </head>
  <body class="writes writes_xhprof-and-drupal-in-two-flavors writes_xhprof-and-drupal-in-two-flavors_index">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->

    <header>
  <nav role="navigation" class="navbar navbar-default">
    <div class="container">
    
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/index.html">alim.ac</a>
      </div>

      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
  <li> <a href="../"><i class="fa fa-pencil"></i> writes</a> </li>
  <li> <a href="../../about/"><i class="fa fa-comment"></i> about</a> </li>
</ul>

      </div>

    </div>
  </nav>
</header>


    <div class="container">
        
<div class="row">
  <div class="col-md-9">
    <article>
      <h1>XHProf and Drupal, in two flavors</h1>
      <div class="article-details">
        <p class="lead">
          <i class="fa fa-calendar"></i>
          Thursday, April 16, 2015
        </p>
        <div class="tags">
            <a href="/writes/tags/drupal/"><i class="fa fa-tag"></i> drupal</a>
            <a href="/writes/tags/php/"><i class="fa fa-tag"></i> php</a>
            <a href="/writes/tags/vagrant/"><i class="fa fa-tag"></i> vagrant</a>
            <a href="/writes/tags/xhprof/"><i class="fa fa-tag"></i> xhprof</a>
        </div>
      </div>
      <p>After my recent <a href="/writes/development-environments-drupal-and-blackfire/">brush with Blackfire</a> at Drupal Dev Days in Montpelliér, I decided to also give another PHP profiling tool a try.

<strong>XHProf</strong> is a “light-weight hierarchical and instrumentation based profiler” and the tool of choice used by sprinters in the <a href="https://groups.drupal.org/node/464283">D8 Accelerate Performance</a> sprint.</p>

<h2 id="environments">Environments</h2>

<p>In <a href="/writes/development-environments-drupal-and-blackfire/">Development Environments, Drupal and Blackfire</a> I described in detail the two environments I have been using:</p>

<ol>
  <li><strong>lightweight, local environment</strong>: Mac OS X, PHP 5.6 and its built-in web server, SQLite</li>
  <li><strong>isolated, virtual environment</strong>: Vagrant-based <a href="http://drupalvm.com">Drupal VM</a> (Ubuntu, PHP 5.5, Apache, MySQL) running on VirtualBox</li>
</ol>

<p>Both have their merits, and I documented how to install and work with XHProf in each case.</p>

<h2 id="local-environment">Local environment</h2>

<p>Prerequisites:</p>

<ul>
  <li>Homebrew</li>
  <li>PHP 5.6</li>
  <li>Composer</li>
  <li>Drush</li>
  <li>Drupal</li>
</ul>

<p>For details about how I installed these prerequisites, check out <a href="/writes/development-environments-drupal-and-blackfire/#local-environment">Development Environments, Drupal and Blackfire</a>.</p>

<h3 id="install-xhprof">Install XHProf</h3>

<p>If you just run <code>brew install xhprof</code> the output will show PHP version-specific packages:</p>

<pre class="highlight plaintext"><code>brew install xhprof
Error: No available formula for xhprof
Searching formulae...
php53-xhprof   php54-xhprof   php55-xhprof   php56-xhprof
</code></pre>

<p>In my case, the appropriate command was:</p>

<pre class="highlight plaintext"><code>brew install php56-xhprof
</code></pre>

<p>The output will include helpful information how to test that XHProf was successfully installed. <code>php -i</code> command shows PHP configuration settings, so all you need to do is search for the “xhprof” string:</p>

<pre class="highlight plaintext"><code>php -i | grep xhprof
/usr/local/etc/php/5.6/conf.d/ext-xhprof.ini
xhprof
xhprof =&gt; 0.9.2
</code></pre>

<h3 id="configure-xhprof">Configure XHProf</h3>

<p>The only configuration needed is to set the output directory in the PHP configuration file for XHProf. Here is my <code>/usr/local/etc/php/5.6/conf.d/ext-xhprof.ini</code> file:</p>

<pre class="highlight plaintext"><code>[xhprof]
extension="/usr/local/opt/php56-xhprof/xhprof.so"
xhprof.output_dir=/tmp
</code></pre>

<p>If your PHP built-in webserver is running, use <code>Ctrl + C</code> to stop it, and start it up again with <code>php -S localhost:8888</code>.</p>

<h3 id="xhprof-drupal-module">XHProf Drupal module</h3>

<p>There is a <a href="https://www.drupal.org/project/xhprof">Drupal XHProf module</a> which provides a native Drupal UI for configuring and rendering profiling results.</p>

<p>I installed the module with <code>git</code> using instructions from <a href="https://www.drupal.org/project/xhprof/git-instructions">Version Control tab</a> of the project page:</p>

<pre class="highlight plaintext"><code>git clone --branch 8.x-1.x http://git.drupal.org/project/XHProf.git
</code></pre>

<p>Once downloaded, visit your Drupal site and navigate to Extend to enable the XHProf module.</p>

<h4 id="configure-drupal-module">Configure Drupal module</h4>

<p>Visit Configuration &gt; XHProf. Check the <em>Enable profiling of page views.</em> option. In the Profiling Settings, check:</p>

<ul>
  <li>Cpu</li>
  <li>Memory</li>
  <li>Exclude PHP builtin functions</li>
  <li>Exclude indirect functions</li>
</ul>

<p>Click <em>Save configuration</em> to finish.</p>

<h4 id="run-profile">Run profile</h4>

<p>To run an XHProf profile, visit any page of your site and scroll down to the bottom. You should see a link titled <strong>XHProf output</strong>. Click on the link to access the XHProf report.</p>

<p><img src="/writes/xhprof-and-drupal-in-two-flavors/xhprof-module-report-54767647.png" width="100%" /></p>

<h3 id="xhprof-native-output">XHProf native output</h3>

<p>XHProf also has a way to display output in its own pages. This view includes additional data that is not displayed in the Drupal module output.</p>

<p>Enabling native output is easy. First, locate the <code>xhprof_html</code> directory. Packages installed with Homebrew will typically be in <code>/usr/local/Cellar/</code>. In this case, the full path is:</p>

<pre class="highlight plaintext"><code>/usr/local/Cellar/php56-xhprof/254eb24/xhprof_html/
</code></pre>

<p>You might see a different string in place of <code>254eb24</code>. You can also use the <code>locate</code> command. First, update the index. Then search for the directory:</p>

<pre class="highlight plaintext"><code>sudo /usr/libexec/locate.updatedb
locate xhprof_html
</code></pre>

<p><code>locate</code> should return a list of all the paths that include <code>xhprof_html</code></p>

<p>Now, create a symbolic link in your Drupal root directory:</p>

<pre class="highlight plaintext"><code>cd ~/druapl8/
ln -s /usr/local/Cellar/php56-xhprof/254eb24/xhprof_html
</code></pre>

<p>When you omit the second argument to <code>ln -s</code> the symbolic link will take the name of the inner-most directory.</p>

<p>With the symbolic link in place, now it’s time to visit: <a href="">http://localhost:8888/xhprof_html/</a>:</p>

<p><img src="/writes/xhprof-and-drupal-in-two-flavors/xhprof-native-output-bcb4e836.png" width="100%" /></p>

<h2 id="drupal-vm">Drupal VM</h2>

<p>Drupal VM has an Ansible role for XHProf. XHProf is included by default. To start profiling, install the XHProf Drupal module.</p>

<h3 id="xhprof-drupal-module-1">XHProf Drupal module</h3>

<p>The <a href="https://www.drupal.org/project/xhprof">module</a> provides a native Drupal UI for configuring and rendering profiling results.</p>

<p>I installed the module with <code>git</code> using instructions from <a href="https://www.drupal.org/project/xhprof/git-instructions">Version Control tab</a> of the project page:</p>

<pre class="highlight plaintext"><code>git clone --branch 8.x-1.x http://git.drupal.org/project/XHProf.git
</code></pre>

<p>Once downloaded, visit your Drupal site and navigate to Extend to enable the XHProf module.</p>

<h4 id="configure-drupal-module-1">Configure Drupal module</h4>

<p>Visit Configuration &gt; XHProf. Check the <em>Enable profiling of page views.</em> option.</p>

<blockquote>
  <p>At this point I ran into an issue where the checkbox was disabled. I found a <a href="https://github.com/geerlingguy/drupal-vm/issues/73">workaround and reported the issue</a> on GitHub. Jeff Geerling, the maintainer of Drupal VM resolved the problem within hours.</p>
</blockquote>

<p>In the Profiling Settings, check:</p>

<ul>
  <li>Cpu</li>
  <li>Memory</li>
  <li>Exclude PHP builtin functions</li>
  <li>Exclude indirect functions</li>
</ul>

<p>Click <em>Save configuration</em> to finish.</p>

<h4 id="run-profile-1">Run profile</h4>

<p>To run an XHProf profile, visit any page of your site and scroll down to the bottom. You should see a link titled <strong>XHProf output</strong>. Click on the link to access the XHProf report.</p>

<p><img src="/writes/xhprof-and-drupal-in-two-flavors/xhprof-module-report-54767647.png" width="100%" /></p>

<h3 id="xhprof-native-output-1">XHProf native output</h3>

<p>XHProf also has a way to display output in its own pages. This view includes additional data that is not displayed in the Drupal module output.</p>

<p>Viewing native output is even easier with Drupal VM. There is a setting in <code>config.yml</code> that configures Apache virtual host to serve XHProf output. All I needed to do is to map the hostname in my <code>/etc/hosts</code> file:</p>

<pre class="highlight plaintext"><code>sudo vim /etc/hosts
</code></pre>

<p>Then add the following line:</p>

<pre class="highlight plaintext"><code>192.168.88.88   local.xhprof.com
</code></pre>

<p>Now in the browser, visit: <a href="http://local.xhprof.com">local.xhprof.com</a> to view the profiling results:</p>

<p><img src="/writes/xhprof-and-drupal-in-two-flavors/local-xhprof-com-65867182.png" width="100%" /></p>


  </article>
  </div>
</div>


    </div>

    <footer>
  <nav class="navbar navbar-default"> 
    <div class="container">
        <ul class="nav navbar-nav social-nav">
  <li> <a href="https://twitter.com/czaroxiejka"><i class="fa fa-twitter"></i> twitter</a> </li>
  <li> <a href="https://github.com/alimac"><i class="fa fa-github"></i> github</a> </li>
  <li> <a href="../../feed.xml"><i class="fa fa-rss"></i> feed</a> </li>
</ul>
 
      </div>  
    </div>
  </nav>
</footer>


        <script src="//code.jquery.com/jquery-2.1.3.min.js" type="text/javascript"></script>
        <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="../../js/plugins-336f429e.js" type="text/javascript"></script>
        <script src="../../js/main-da39a3ee.js" type="text/javascript"></script>

        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-47875058-1', 'alim.ac');
          ga('send', 'pageview');
        </script>
    </body>
</html>
